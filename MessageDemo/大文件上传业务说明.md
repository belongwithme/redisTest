# 大文件上传业务 + MinIO + RabbitMQ 实现方案

## 项目概述

本项目在原有RabbitMQ Demo基础上，集成了MinIO对象存储和大文件上传功能，展示了如何在文件上传业务中有效地使用RabbitMQ进行异步处理。

## 架构设计

### 业务流程图
```
文件上传 → MinIO存储 → RabbitMQ消息 → 异步处理 → 结果通知
    ↓
[用户上传文件]
    ↓
[存储到MinIO]
    ↓
[发送上传完成消息]
    ↓
[触发各种异步处理]
    ↓
[处理完成通知]
```

### 系统组件
1. **MinIO**: 对象存储，负责文件的实际存储
2. **RabbitMQ**: 消息队列，负责异步任务调度
3. **Spring Boot**: 应用框架，提供REST API
4. **业务处理器**: 各种文件处理任务的执行器

## RabbitMQ在文件上传中的应用场景

### 1. 异步处理场景
- **文件上传完成通知**: 上传完成后通知其他系统
- **文件处理队列**: 图片压缩、视频转码、文档解析等
- **进度通知**: 实时推送处理进度

### 2. 解耦和可靠性
- **服务解耦**: 上传服务与处理服务分离
- **削峰填谷**: 处理高峰期请求压力
- **失败重试**: 处理失败的任务自动重试

### 3. 业务流程编排
- **多步骤处理**: 上传→扫描→转换→通知→存档
- **优先级处理**: 安全扫描高优先级，清理任务低优先级
- **分发机制**: 一个文件触发多个处理器

## 核心功能

### 文件上传API
```bash
# 单文件上传
POST /api/files/upload
Content-Type: multipart/form-data

# 批量文件上传
POST /api/files/upload/batch
Content-Type: multipart/form-data

# 手动触发文件处理
POST /api/files/process/{bucketName}/{objectKey}?processType=IMAGE_COMPRESS&priority=8
```

### 消息队列结构
```
file.exchange (Topic Exchange)
├── file.upload.queue          # 文件上传完成队列
├── file.process.queue         # 文件处理队列
└── file.notify.queue          # 通知队列
```

### 处理类型
1. **UPLOAD_COMPLETED**: 上传完成通知
2. **SECURITY_SCAN**: 安全扫描（最高优先级）
3. **IMAGE_COMPRESS**: 图片压缩
4. **VIDEO_TRANSCODE**: 视频转码
5. **DOCUMENT_PARSE**: 文档解析
6. **THUMBNAIL_GENERATE**: 缩略图生成
7. **CONTENT_AUDIT**: 内容审核
8. **BACKUP_PROCESS**: 备份处理
9. **CLEANUP_EXPIRED**: 清理过期文件

## 快速启动

### 1. 启动基础服务
```bash
# 启动RabbitMQ和MinIO
docker-compose -f docker-compose-minio.yml up -d

# 查看服务状态
docker-compose -f docker-compose-minio.yml ps
```

### 2. 访问管理界面
- **RabbitMQ管理界面**: http://localhost:15672 (admin/admin123)
- **MinIO控制台**: http://localhost:9001 (minioadmin/minioadmin)

### 3. 启动应用
```bash
mvn spring-boot:run
```

### 4. 测试文件上传
```bash
# 上传图片文件
curl -X POST "http://localhost:8080/api/files/upload" \
  -F "file=@test-image.jpg" \
  -F "uploadUserId=user123" \
  -F "businessTag=profile" \
  -F "description=用户头像" \
  -F "enableAsyncProcess=true"

# 查看支持的文件类型
curl "http://localhost:8080/api/files/supported-types"
```

## 消息流转示例

### 图片上传处理流程
1. **用户上传图片** → MinIO存储
2. **发送upload_completed消息** → file.upload队列
3. **消费者处理**:
   - 触发缩略图生成 → file.process.thumbnail_generate
   - 触发图片压缩 → file.process.image_compress
   - 触发安全扫描 → file.process.security_scan
4. **各处理器完成后** → file.notify队列通知

### 视频上传处理流程
1. **用户上传视频** → MinIO存储
2. **发送upload_completed消息** → file.upload队列
3. **消费者处理**:
   - 触发视频转码 → file.process.video_transcode
   - 触发安全扫描 → file.process.security_scan
4. **处理完成通知** → file.notify队列

## 配置说明

### MinIO配置
```yaml
minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
  default-bucket: file-storage
  max-file-size: 104857600  # 100MB
  allowed-content-types:
    - image/jpeg
    - image/png
    - video/mp4
    # ... 更多类型
```

### RabbitMQ配置
```yaml
rabbitmq:
  queue:
    file-upload: file.upload.queue
    file-process: file.process.queue
    file-notify: file.notify.queue
  exchange:
    file: file.exchange
  routing:
    file-upload: file.upload
    file-process: file.process
    file-notify: file.notify
```

## 扩展和优化

### 性能优化
1. **分片上传**: 大文件自动分片上传
2. **并发处理**: 多个消费者并行处理
3. **缓存策略**: Redis缓存文件元数据
4. **CDN集成**: 静态文件CDN分发

### 监控和运维
1. **健康检查**: /api/files/health
2. **指标监控**: Actuator + Prometheus
3. **日志管理**: 结构化日志输出
4. **告警机制**: 处理失败告警

### 安全考虑
1. **文件类型检查**: 白名单机制
2. **文件大小限制**: 防止滥用
3. **病毒扫描**: 集成杀毒引擎
4. **访问控制**: JWT + 权限控制

## 实际应用场景

### 1. 内容管理系统
- 用户上传头像/文档
- 自动生成缩略图
- 内容审核和备份

### 2. 视频处理平台
- 视频上传和转码
- 格式转换和压缩
- CDN分发准备

### 3. 企业文档系统
- 文档上传和解析
- 全文检索索引
- 版本管理和备份

### 4. 图片处理服务
- 批量图片上传
- 自动压缩和优化
- 多尺寸生成

## 总结

这个实现方案展示了在大文件上传业务中，RabbitMQ如何发挥关键作用：

1. **异步解耦**: 上传和处理分离，提升用户体验
2. **可靠性**: 消息持久化，失败重试机制
3. **扩展性**: 水平扩展处理能力
4. **灵活性**: 支持多种处理类型和优先级

通过这种架构，可以轻松应对大规模文件处理需求，同时保证系统的稳定性和可维护性。