# ğŸ¯ ä¼ä¸šçº§RabbitMQå­¦ä¹ è·¯å¾„æŒ‡å—

> ä»ä½ ç°æœ‰çš„Demoå‡ºå‘ï¼Œç³»ç»ŸæŒæ¡ä¼ä¸šé¡¹ç›®ä¸­RabbitMQçš„çµæ´»è¿ç”¨

## ğŸ“š å­¦ä¹ è·¯å¾„æ€»è§ˆ

```mermaid
graph LR
    A[å½“å‰DemoåŸºç¡€] --> B[ç¬¬ä¸€é˜¶æ®µ<br/>å·©å›ºæ ¸å¿ƒæ¦‚å¿µ]
    B --> C[ç¬¬äºŒé˜¶æ®µ<br/>æ‰©å±•è·¯ç”±æ¨¡å¼]
    C --> D[ç¬¬ä¸‰é˜¶æ®µ<br/>å¼‚å¸¸å¤„ç†æœºåˆ¶]
    D --> E[ç¬¬å››é˜¶æ®µ<br/>æ€§èƒ½ä¼˜åŒ–]
    E --> F[ç¬¬äº”é˜¶æ®µ<br/>ç”Ÿäº§çº§ç‰¹æ€§]
    F --> G[ç¬¬å…­é˜¶æ®µ<br/>å®é™…ä¸šåŠ¡åº”ç”¨]
    
    B --> B1[æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ<br/>ç¡®è®¤æœºåˆ¶<br/>è¿æ¥ç®¡ç†]
    C --> C1[Topicè·¯ç”±<br/>Fanoutå¹¿æ’­<br/>Headersè·¯ç”±]
    D --> D1[æ™ºèƒ½é‡è¯•<br/>æ­»ä¿¡å¤„ç†<br/>ç†”æ–­æœºåˆ¶]
    E --> E1[æ‰¹é‡å¤„ç†<br/>è¿æ¥æ± <br/>å†…å­˜ä¼˜åŒ–]
    F --> F1[ç›‘æ§å‘Šè­¦<br/>å¥åº·æ£€æŸ¥<br/>å®‰å…¨é…ç½®]
    G --> G1[è®¢å•æµç¨‹<br/>æ”¯ä»˜ç³»ç»Ÿ<br/>ç”¨æˆ·ç®¡ç†]
```

---

## ğŸ¯ ç¬¬ä¸€é˜¶æ®µï¼šå·©å›ºæ ¸å¿ƒæ¦‚å¿µï¼ˆç¬¬1-2å‘¨ï¼‰

### ğŸ“– ç†è®ºæ·±åŒ–

#### 1.1 æ·±å…¥ç†è§£ä½ ç°æœ‰çš„é…ç½®
```java
// åˆ†æä½ çš„RabbitConfig.javaä¸­çš„æ¯ä¸€ä¸ªé…ç½®é¡¹
@Bean
public Queue helloQueue() {
    return QueueBuilder
        .durable(helloQueueName)                                    // â“ ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–ï¼Ÿ
        .withArgument("x-dead-letter-exchange", deadLetterExchangeName)  // â“ æ­»ä¿¡æœºåˆ¶çš„è§¦å‘æ¡ä»¶ï¼Ÿ
        .withArgument("x-dead-letter-routing-key", deadLetterRoutingKey) // â“ è·¯ç”±é”®çš„ä½œç”¨ï¼Ÿ
        .withArgument("x-message-ttl", 600000)                      // â“ TTLä¸ä¸šåŠ¡çš„å…³ç³»ï¼Ÿ
        .build();
}
```

**æ·±åŒ–å­¦ä¹ ä»»åŠ¡ï¼š**
1. æ‰‹åŠ¨åˆ›å»ºæ¶ˆæ¯ï¼Œè§‚å¯ŸTTLè¿‡æœŸåçš„è¡Œä¸º
2. æ¨¡æ‹Ÿæ¶ˆè´¹è€…å¼‚å¸¸ï¼Œè§‚å¯Ÿæ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆæ¯æµè½¬
3. æµ‹è¯•ä¸åŒACKæ¨¡å¼çš„åŒºåˆ«ï¼ˆè‡ªåŠ¨vsæ‰‹åŠ¨ï¼‰

#### 1.2 æ¶ˆæ¯ç¡®è®¤æœºåˆ¶å®è·µ
```java
// åœ¨ä½ çš„MessageConsumerä¸­æ·»åŠ æ‰‹åŠ¨ç¡®è®¤
@Component
public class ManualAckConsumer {
    
    @RabbitListener(queues = "hello.queue", ackMode = "MANUAL")
    public void handleMessageWithManualAck(String message, Channel channel, 
                                          @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
        try {
            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
            if (message.contains("error")) {
                throw new RuntimeException("Business error");
            }
            
            // ä¸šåŠ¡æˆåŠŸï¼Œæ‰‹åŠ¨ç¡®è®¤
            channel.basicAck(tag, false);
            log.info("æ¶ˆæ¯å¤„ç†æˆåŠŸå¹¶ç¡®è®¤: {}", message);
            
        } catch (Exception e) {
            try {
                // ä¸šåŠ¡å¤±è´¥ï¼Œæ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
                channel.basicNack(tag, false, true);
                log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œé‡æ–°å…¥é˜Ÿ: {}", message);
            } catch (IOException ex) {
                log.error("ç¡®è®¤æ¶ˆæ¯æ—¶å‘ç”Ÿå¼‚å¸¸", ex);
            }
        }
    }
}
```

**å®è·µä»»åŠ¡ï¼š**
1. å‘é€åŒ…å«"error"çš„æ¶ˆæ¯ï¼Œè§‚å¯Ÿé‡è¯•è¡Œä¸º
2. æ•…æ„è®©æ¶ˆè´¹è€…å¤„ç†è¶…æ—¶ï¼Œè§‚å¯Ÿunackæ¶ˆæ¯
3. æ¯”è¾ƒæ‰‹åŠ¨ç¡®è®¤ä¸è‡ªåŠ¨ç¡®è®¤çš„æ€§èƒ½å·®å¼‚

### ğŸ› ï¸ å®è·µé¡¹ç›®

#### é¡¹ç›®1ï¼šæ¶ˆæ¯ç¡®è®¤æœºåˆ¶æ·±åº¦æµ‹è¯•
```bash
# åœ¨ä½ çš„MessageControllerä¸­æ·»åŠ æ–°çš„æµ‹è¯•æ¥å£
@PostMapping("/test-ack-modes")
public ResponseEntity<String> testAckModes(@RequestParam String mode) {
    switch(mode) {
        case "auto":
            // å‘é€åˆ°è‡ªåŠ¨ç¡®è®¤é˜Ÿåˆ—
            break;
        case "manual":
            // å‘é€åˆ°æ‰‹åŠ¨ç¡®è®¤é˜Ÿåˆ—
            break;
        case "error":
            // å‘é€é”™è¯¯æ¶ˆæ¯æµ‹è¯•é‡è¯•
            break;
    }
}
```

---

## ğŸ”„ ç¬¬äºŒé˜¶æ®µï¼šæ‰©å±•è·¯ç”±æ¨¡å¼ï¼ˆç¬¬3-4å‘¨ï¼‰

### ğŸ“– ç†è®ºå­¦ä¹ 

#### 2.1 Topic Exchange å®é™…åº”ç”¨åœºæ™¯
```java
// ç”µå•†ç³»ç»Ÿçš„è®¢å•çŠ¶æ€æ›´æ–°è·¯ç”±
public class OrderStatusRouting {
    /*
    è·¯ç”±é”®è®¾è®¡ï¼š
    - order.{region}.{status}
    - order.beijing.created    (åŒ—äº¬åœ°åŒºæ–°è®¢å•)
    - order.shanghai.paid      (ä¸Šæµ·åœ°åŒºå·²æ”¯ä»˜)
    - order.*.cancelled        (æ‰€æœ‰åœ°åŒºå–æ¶ˆè®¢å•)
    - order.beijing.*          (åŒ—äº¬åœ°åŒºæ‰€æœ‰çŠ¶æ€)
    */
}
```

#### 2.2 Fanout Exchange ç³»ç»Ÿäº‹ä»¶å¹¿æ’­
```java
// ç”¨æˆ·ä¿¡æ¯æ›´æ–°çš„ç³»ç»Ÿå¹¿æ’­
public class UserUpdateBroadcast {
    /*
    åº”ç”¨åœºæ™¯ï¼š
    - ç”¨æˆ·ä¿®æ”¹ä¸ªäººä¿¡æ¯å
    - ç¼“å­˜æœåŠ¡éœ€è¦æ¸…ç†ç”¨æˆ·ç¼“å­˜
    - æ¨èæœåŠ¡éœ€è¦æ›´æ–°ç”¨æˆ·ç”»åƒ
    - ç§¯åˆ†æœåŠ¡éœ€è¦é‡æ–°è®¡ç®—ç­‰çº§
    */
}
```

### ğŸ› ï¸ å®è·µé¡¹ç›®

#### é¡¹ç›®2ï¼šæ„å»ºç”µå•†è®¢å•è·¯ç”±ç³»ç»Ÿ
```java
// ç¬¬1æ­¥ï¼šåœ¨ä½ çš„é¡¹ç›®ä¸­æ·»åŠ OrderRoutingConfig
@Configuration
public class OrderRoutingConfig {
    
    @Bean
    public TopicExchange orderTopicExchange() {
        return ExchangeBuilder.topicExchange("order.topic.exchange")
            .durable(true).build();
    }
    
    // åŒ—äº¬åœ°åŒºè®¢å•å¤„ç†é˜Ÿåˆ—
    @Bean
    public Queue beijingOrderQueue() {
        return QueueBuilder.durable("order.beijing.queue").build();
    }
    
    // VIPè®¢å•å¤„ç†é˜Ÿåˆ—
    @Bean  
    public Queue vipOrderQueue() {
        return QueueBuilder.durable("order.vip.queue").build();
    }
    
    // è´¢åŠ¡ç»Ÿè®¡é˜Ÿåˆ—
    @Bean
    public Queue financeQueue() {
        return QueueBuilder.durable("finance.all.queue").build();
    }
    
    // è·¯ç”±ç»‘å®š
    @Bean
    public Binding beijingOrderBinding() {
        return BindingBuilder.bind(beijingOrderQueue())
            .to(orderTopicExchange())
            .with("order.beijing.*");
    }
    
    @Bean
    public Binding vipOrderBinding() {
        return BindingBuilder.bind(vipOrderQueue())
            .to(orderTopicExchange())
            .with("order.*.vip");
    }
    
    @Bean
    public Binding financeBinding() {
        return BindingBuilder.bind(financeQueue())
            .to(orderTopicExchange())
            .with("order.#");  // æ¥æ”¶æ‰€æœ‰è®¢å•æ¶ˆæ¯
    }
}
```

**å­¦ä¹ ç›®æ ‡ï¼š**
1. ç†è§£Topicè·¯ç”±çš„é€šé…ç¬¦è§„åˆ™
2. è®¾è®¡åˆç†çš„è·¯ç”±é”®å‘½åè§„èŒƒ
3. å¤„ç†è·¯ç”±é”®å†²çªå’Œé‡å¤æ¶ˆè´¹

#### é¡¹ç›®3ï¼šç”¨æˆ·äº‹ä»¶å¹¿æ’­ç³»ç»Ÿ
```java
// ç¬¬2æ­¥ï¼šæ·»åŠ ç”¨æˆ·äº‹ä»¶å¹¿æ’­
@Configuration  
public class UserEventBroadcastConfig {
    
    @Bean
    public FanoutExchange userEventExchange() {
        return ExchangeBuilder.fanoutExchange("user.event.fanout")
            .durable(true).build();
    }
    
    // å„ä¸ªæœåŠ¡çš„å¤„ç†é˜Ÿåˆ—
    @Bean public Queue cacheUpdateQueue() { 
        return QueueBuilder.durable("cache.user.update").build(); 
    }
    
    @Bean public Queue recommendationUpdateQueue() { 
        return QueueBuilder.durable("recommendation.user.update").build(); 
    }
    
    @Bean public Queue pointsUpdateQueue() { 
        return QueueBuilder.durable("points.user.update").build(); 
    }
}
```

**å­¦ä¹ ç›®æ ‡ï¼š**
1. ç†è§£Fanoutçš„å¹¿æ’­ç‰¹æ€§
2. è®¾è®¡æœåŠ¡è§£è€¦çš„äº‹ä»¶é©±åŠ¨æ¶æ„
3. å¤„ç†å¹¿æ’­æ¶ˆæ¯çš„å¹‚ç­‰æ€§é—®é¢˜

---

## âš¡ ç¬¬ä¸‰é˜¶æ®µï¼šå¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆç¬¬5-6å‘¨ï¼‰

### ğŸ“– ç†è®ºæ·±åŒ–

#### 3.1 å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥
```yaml
å¼‚å¸¸ç±»å‹åˆ†ç±»:
  ä¸´æ—¶æ€§å¼‚å¸¸:
    - ç½‘ç»œè¶…æ—¶
    - æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
    - èµ„æºä¸´æ—¶é”å®š
    ç­–ç•¥: æŒ‡æ•°é€€é¿é‡è¯•
    
  ä¸šåŠ¡å¼‚å¸¸:
    - æ•°æ®æ ¼å¼é”™è¯¯
    - ä¸šåŠ¡è§„åˆ™æ ¡éªŒå¤±è´¥
    - é‡å¤æ“ä½œ
    ç­–ç•¥: è®°å½•æ—¥å¿—ï¼Œäººå·¥å¤„ç†
    
  ç³»ç»Ÿå¼‚å¸¸:
    - å†…å­˜æº¢å‡º
    - ç£ç›˜ç©ºé—´ä¸è¶³
    - æ•°æ®åº“è¿æ¥æ± è€—å°½
    ç­–ç•¥: ç†”æ–­ï¼Œå‘Šè­¦ï¼Œé™çº§
```

### ğŸ› ï¸ å®è·µé¡¹ç›®

#### é¡¹ç›®4ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶
```java
// ç¬¬3æ­¥ï¼šåœ¨ä½ çš„é¡¹ç›®ä¸­å®ç°æ™ºèƒ½é‡è¯•
@Component
public class IntelligentRetryService {
    
    // é‡è¯•é…ç½®
    private static final int MAX_RETRY_COUNT = 5;
    private static final long[] RETRY_DELAYS = {1000, 2000, 4000, 8000, 16000}; // æŒ‡æ•°é€€é¿
    
    @RabbitListener(queues = "business.order.queue")
    public void processOrder(OrderMessage order, 
                           @Header(value = "x-retry-count", defaultValue = "0") Integer retryCount,
                           @Header("messageId") String messageId) {
        try {
            // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„å¼‚å¸¸
            if (order.getAmount().compareTo(BigDecimal.ZERO) < 0) {
                throw new BusinessException("è®¢å•é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
            }
            
            if (order.getProductId() == null) {
                throw new TemporaryException("äº§å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
            }
            
            // æ­£å¸¸ä¸šåŠ¡å¤„ç†
            orderService.processOrder(order);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ä¸é‡è¯•ï¼Œç›´æ¥è¿›å…¥äººå·¥å¤„ç†
            sendToManualProcessing(order, e.getMessage());
            
        } catch (TemporaryException e) {
            // ä¸´æ—¶å¼‚å¸¸ï¼Œæ™ºèƒ½é‡è¯•
            if (retryCount < MAX_RETRY_COUNT) {
                scheduleRetry(order, messageId, retryCount + 1);
            } else {
                sendToDeadLetter(order, "è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°");
            }
        }
    }
    
    private void scheduleRetry(OrderMessage order, String messageId, int retryCount) {
        long delay = RETRY_DELAYS[retryCount - 1];
        
        // å‘é€åˆ°å»¶è¿Ÿé‡è¯•é˜Ÿåˆ—
        rabbitTemplate.convertAndSend("retry.delay.exchange", 
            "retry.delay.key", order, message -> {
                message.getMessageProperties().setExpiration(String.valueOf(delay));
                message.getMessageProperties().getHeaders().put("x-retry-count", retryCount);
                message.getMessageProperties().getHeaders().put("messageId", messageId);
                return message;
        });
        
        log.info("è®¢å• {} ç¬¬ {} æ¬¡é‡è¯•ï¼Œå»¶è¿Ÿ {} ms", order.getOrderId(), retryCount, delay);
    }
}
```

#### é¡¹ç›®5ï¼šç†”æ–­å™¨é›†æˆ
```java
// ç¬¬4æ­¥ï¼šé›†æˆResilience4jç†”æ–­å™¨
@Component
public class CircuitBreakerOrderProcessor {
    
    @CircuitBreaker(name = "payment-service", fallbackMethod = "fallbackPayment")
    @TimeLimiter(name = "payment-service")
    @Retry(name = "payment-service")
    @RabbitListener(queues = "payment.process.queue")
    public CompletableFuture<String> processPayment(PaymentMessage payment) {
        return CompletableFuture.supplyAsync(() -> {
            // è°ƒç”¨å¤–éƒ¨æ”¯ä»˜æœåŠ¡
            return paymentService.processPayment(payment);
        });
    }
    
    // ç†”æ–­é™çº§æ–¹æ³•
    public CompletableFuture<String> fallbackPayment(PaymentMessage payment, Exception ex) {
        log.warn("æ”¯ä»˜æœåŠ¡ç†”æ–­ï¼Œè®¢å• {} è¿›å…¥é™çº§å¤„ç†", payment.getOrderId());
        
        // é™çº§ç­–ç•¥ï¼šå‘é€åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œç¨åé‡è¯•
        rabbitTemplate.convertAndSend("payment.fallback.exchange", 
            "payment.fallback.key", payment, message -> {
                message.getMessageProperties().setExpiration("300000"); // 5åˆ†é’Ÿåé‡è¯•
                return message;
        });
        
        return CompletableFuture.completedFuture("fallback");
    }
}
```

**å­¦ä¹ ç›®æ ‡ï¼š**
1. æŒæ¡ä¸åŒå¼‚å¸¸çš„å¤„ç†ç­–ç•¥
2. å®ç°æ™ºèƒ½é‡è¯•å’Œç†”æ–­æœºåˆ¶
3. è®¾è®¡é™çº§å’Œæ¢å¤ç­–ç•¥

---

## ğŸš€ ç¬¬å››é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆç¬¬7-8å‘¨ï¼‰

### ğŸ“– ç†è®ºå­¦ä¹ 

#### 4.1 æ€§èƒ½ä¼˜åŒ–å…³é”®æŒ‡æ ‡
```yaml
å…³é”®æ€§èƒ½æŒ‡æ ‡:
  ååé‡(Throughput):
    ç›®æ ‡: >1000 msg/s
    ä¼˜åŒ–: æ‰¹é‡å¤„ç†ã€å¹¶å‘æ¶ˆè´¹
    
  å»¶è¿Ÿ(Latency):
    ç›®æ ‡: <100ms P99
    ä¼˜åŒ–: è¿æ¥æ± ã€é¢„å–ä¼˜åŒ–
    
  å¯ç”¨æ€§(Availability):
    ç›®æ ‡: >99.9%
    ä¼˜åŒ–: é‡è¯•æœºåˆ¶ã€ç†”æ–­å™¨
    
  èµ„æºåˆ©ç”¨ç‡:
    å†…å­˜: <80%
    CPU: <70%
    è¿æ¥æ•°: <100
```

### ğŸ› ï¸ å®è·µé¡¹ç›®

#### é¡¹ç›®6ï¼šæ‰¹é‡æ¶ˆæ¯å¤„ç†ä¼˜åŒ–
```java
// ç¬¬5æ­¥ï¼šå®ç°æ‰¹é‡æ¶ˆæ¯å¤„ç†
@Component
public class BatchOrderProcessor {
    
    private final BlockingQueue<OrderMessage> orderBuffer = new LinkedBlockingQueue<>(1000);
    private final ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();
    
    @PostConstruct
    public void initBatchProcessor() {
        // æ¯5ç§’æˆ–è¾¾åˆ°100æ¡æ¶ˆæ¯æ—¶æ‰¹é‡å¤„ç†
        scheduler.scheduleAtFixedRate(this::processBatch, 5, 5, TimeUnit.SECONDS);
    }
    
    @RabbitListener(queues = "order.single.queue", concurrency = "5-10")
    public void collectOrder(OrderMessage order) {
        if (!orderBuffer.offer(order)) {
            log.warn("è®¢å•ç¼“å†²åŒºå·²æ»¡ï¼Œç›´æ¥å¤„ç†: {}", order.getOrderId());
            orderService.processSingle(order);
        }
        
        // ç¼“å†²åŒºæ»¡æ—¶ç«‹å³è§¦å‘æ‰¹é‡å¤„ç†
        if (orderBuffer.size() >= 100) {
            processBatch();
        }
    }
    
    private void processBatch() {
        List<OrderMessage> batch = new ArrayList<>();
        orderBuffer.drainTo(batch, 100);
        
        if (!batch.isEmpty()) {
            try {
                orderService.processBatch(batch);
                log.info("æ‰¹é‡å¤„ç†è®¢å•å®Œæˆï¼Œæ•°é‡: {}", batch.size());
            } catch (Exception e) {
                log.error("æ‰¹é‡å¤„ç†å¤±è´¥ï¼Œå›é€€åˆ°å•æ¡å¤„ç†", e);
                batch.forEach(order -> orderService.processSingle(order));
            }
        }
    }
}
```

#### é¡¹ç›®7ï¼šè¿æ¥æ± å’Œå¹¶å‘ä¼˜åŒ–
```java
// ç¬¬6æ­¥ï¼šä¼˜åŒ–è¿æ¥æ± é…ç½®
@Configuration
public class HighPerformanceRabbitConfig {
    
    @Bean
    @Primary
    public CachingConnectionFactory highPerformanceConnectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory("localhost");
        
        // è¿æ¥æ± ä¼˜åŒ–
        factory.setChannelCacheSize(200);           // å¢åŠ é€šé“ç¼“å­˜
        factory.setConnectionCacheSize(20);         // å¢åŠ è¿æ¥ç¼“å­˜
        factory.setChannelCheckoutTimeout(2000);    // å‡å°‘è·å–è¶…æ—¶
        
        // æ€§èƒ½ä¼˜åŒ–
        factory.setRequestedHeartBeat(60);          // é€‚å½“å¢åŠ å¿ƒè·³é—´éš”
        factory.setConnectionTimeout(10000);        // å‡å°‘è¿æ¥è¶…æ—¶
        
        // ç¡®è®¤æœºåˆ¶ä¼˜åŒ–
        factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.SIMPLE);
        
        return factory;
    }
    
    @Bean
    public SimpleRabbitListenerContainerFactory highPerformanceListenerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // å¹¶å‘ä¼˜åŒ–
        factory.setConcurrentConsumers(10);         // å¢åŠ æœ€å°æ¶ˆè´¹è€…
        factory.setMaxConcurrentConsumers(50);      // å¢åŠ æœ€å¤§æ¶ˆè´¹è€…
        factory.setPrefetchCount(20);               // å¢åŠ é¢„å–æ•°é‡
        
        // æ€§èƒ½ä¼˜åŒ–
        factory.setReceiveTimeout(1000L);           // å‡å°‘æ¥æ”¶è¶…æ—¶
        factory.setDefaultRequeueRejected(false);   // å¤±è´¥æ¶ˆæ¯ä¸é‡æ–°å…¥é˜Ÿ
        factory.setMissingQueuesFatal(false);       // é˜Ÿåˆ—ç¼ºå¤±ä¸è‡´å‘½
        
        return factory;
    }
}
```

**å­¦ä¹ ç›®æ ‡ï¼š**
1. ç†è§£æ‰¹é‡å¤„ç†çš„æ€§èƒ½æ”¶ç›Š
2. æŒæ¡è¿æ¥æ± å’Œå¹¶å‘é…ç½®
3. å­¦ä¼šæ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜

---

## ğŸ­ ç¬¬äº”é˜¶æ®µï¼šç”Ÿäº§çº§ç‰¹æ€§ï¼ˆç¬¬9-10å‘¨ï¼‰

### ğŸ“– ç†è®ºå­¦ä¹ 

#### 5.1 ç”Ÿäº§ç¯å¢ƒå…³é”®ç‰¹æ€§
```yaml
ç›‘æ§å‘Šè­¦:
  - é˜Ÿåˆ—é•¿åº¦ç›‘æ§
  - æ¶ˆæ¯å¤„ç†è€—æ—¶
  - é”™è¯¯ç‡ç»Ÿè®¡
  - è¿æ¥æ•°ç›‘æ§
  
å®‰å…¨é…ç½®:
  - SSL/TLSåŠ å¯†
  - ç”¨æˆ·æƒé™ç®¡ç†
  - ç½‘ç»œè®¿é—®æ§åˆ¶
  - æ•æ„Ÿä¿¡æ¯åŠ å¯†
  
é«˜å¯ç”¨:
  - å¤šèŠ‚ç‚¹éƒ¨ç½²
  - è‡ªåŠ¨æ•…éšœè½¬ç§»
  - æ•°æ®å¤‡ä»½æ¢å¤
  - ç¾éš¾æ¢å¤è®¡åˆ’
```

### ğŸ› ï¸ å®è·µé¡¹ç›®

#### é¡¹ç›®8ï¼šå®Œæ•´ç›‘æ§ç³»ç»Ÿ
```java
// ç¬¬7æ­¥ï¼šå®ç°å…¨é¢ç›‘æ§
@Component
public class ProductionRabbitMonitoring {
    
    private final MeterRegistry meterRegistry;
    private final AlertService alertService;
    
    // é˜Ÿåˆ—é•¿åº¦ç›‘æ§
    @Scheduled(fixedRate = 30000)
    public void monitorQueueSizes() {
        Map<String, Integer> queueSizes = rabbitAdmin.getQueueProperties();
        
        queueSizes.forEach((queueName, size) -> {
            meterRegistry.gauge("rabbitmq.queue.size", 
                Tags.of("queue", queueName), size);
            
            // å‘Šè­¦é˜ˆå€¼æ£€æŸ¥
            if (size > getAlertThreshold(queueName)) {
                alertService.sendAlert(String.format(
                    "é˜Ÿåˆ— %s æ¶ˆæ¯å †ç§¯ï¼Œå½“å‰æ•°é‡: %d", queueName, size));
            }
        });
    }
    
    // æ¶ˆæ¯å¤„ç†æ€§èƒ½ç›‘æ§
    @EventListener
    public void handleMessageProcessed(MessageProcessedEvent event) {
        meterRegistry.timer("rabbitmq.message.processing.time",
            Tags.of("queue", event.getQueueName(),
                   "status", event.getStatus()))
            .record(event.getProcessingTime(), TimeUnit.MILLISECONDS);
    }
    
    // é”™è¯¯ç‡ç›‘æ§
    @EventListener
    public void handleMessageFailed(MessageFailedEvent event) {
        meterRegistry.counter("rabbitmq.message.failed",
            Tags.of("queue", event.getQueueName(),
                   "error", event.getErrorType()))
            .increment();
    }
}
```

#### é¡¹ç›®9ï¼šå¥åº·æ£€æŸ¥å’Œæ•…éšœæ¢å¤
```java
// ç¬¬8æ­¥ï¼šå®ç°å¥åº·æ£€æŸ¥
@Component
public class ProductionHealthCheck implements HealthIndicator {
    
    @Override
    public Health health() {
        Map<String, Object> details = new HashMap<>();
        Health.Builder builder = Health.up();
        
        try {
            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            checkConnectionHealth(details, builder);
            
            // æ£€æŸ¥å…³é”®é˜Ÿåˆ—çŠ¶æ€
            checkCriticalQueues(details, builder);
            
            // æ£€æŸ¥æ¶ˆè´¹è€…çŠ¶æ€
            checkConsumerHealth(details, builder);
            
            // æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
            checkPerformanceMetrics(details, builder);
            
        } catch (Exception e) {
            builder.down().withDetail("error", e.getMessage());
        }
        
        return builder.withDetails(details).build();
    }
    
    private void checkPerformanceMetrics(Map<String, Object> details, Health.Builder builder) {
        // æ£€æŸ¥å¹³å‡å¤„ç†æ—¶é—´
        Double avgProcessingTime = meterRegistry.timer("rabbitmq.message.processing.time")
            .mean(TimeUnit.MILLISECONDS);
            
        details.put("avgProcessingTime", avgProcessingTime);
        
        if (avgProcessingTime > 1000) { // è¶…è¿‡1ç§’å‘Šè­¦
            builder.down().withDetail("performance", "å¤„ç†æ—¶é—´è¿‡é•¿: " + avgProcessingTime + "ms");
        }
    }
}
```

**å­¦ä¹ ç›®æ ‡ï¼š**
1. æ„å»ºå®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»
2. å®ç°ç”Ÿäº§çº§å¥åº·æ£€æŸ¥
3. æŒæ¡æ•…éšœè¯Šæ–­å’Œæ¢å¤æŠ€èƒ½

---

## ğŸ¢ ç¬¬å…­é˜¶æ®µï¼šå®é™…ä¸šåŠ¡åº”ç”¨ï¼ˆç¬¬11-12å‘¨ï¼‰

### ğŸ“– ä¸šåŠ¡åœºæ™¯åˆ†æ

#### 6.1 ç”µå•†ç³»ç»Ÿè®¢å•æµç¨‹
```mermaid
graph LR
    A[ä¸‹å•] --> B[åº“å­˜æ£€æŸ¥]
    B --> C[ç”Ÿæˆè®¢å•]
    C --> D[å‘èµ·æ”¯ä»˜]
    D --> E[æ”¯ä»˜æˆåŠŸ]
    E --> F[æ‰£å‡åº“å­˜]
    F --> G[ç”Ÿæˆå‘è´§å•]
    G --> H[ç‰©æµé…é€]
    H --> I[ç¡®è®¤æ”¶è´§]
    
    B --> B1[åº“å­˜ä¸è¶³]
    B1 --> B2[è®¢å•å–æ¶ˆ]
    
    D --> D1[æ”¯ä»˜å¤±è´¥]
    D1 --> D2[é‡Šæ”¾åº“å­˜]
```

### ğŸ› ï¸ ç»¼åˆé¡¹ç›®

#### é¡¹ç›®10ï¼šå®Œæ•´ç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ
```java
// ç¬¬9æ­¥ï¼šå®ç°å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
@Component
public class ECommerceOrderOrchestrator {
    
    // 1. è®¢å•åˆ›å»ºäº‹ä»¶å¤„ç†
    @RabbitListener(queues = "order.created.queue")
    public void handleOrderCreated(OrderCreatedEvent event) {
        log.info("å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶: {}", event.getOrderId());
        
        try {
            // è°ƒç”¨åº“å­˜æœåŠ¡æ£€æŸ¥
            InventoryCheckResult result = inventoryService.checkAndReserve(
                event.getOrderId(), event.getItems());
            
            if (result.isSuccess()) {
                // åº“å­˜å……è¶³ï¼Œå‘é€åˆ°æ”¯ä»˜é˜Ÿåˆ—
                PaymentRequest paymentRequest = PaymentRequest.builder()
                    .orderId(event.getOrderId())
                    .amount(event.getTotalAmount())
                    .userId(event.getUserId())
                    .build();
                    
                rabbitTemplate.convertAndSend("payment.exchange", 
                    "payment.process", paymentRequest);
                    
                log.info("è®¢å• {} å·²å‘é€åˆ°æ”¯ä»˜å¤„ç†", event.getOrderId());
            } else {
                // åº“å­˜ä¸è¶³ï¼Œå‘é€è®¢å•å–æ¶ˆäº‹ä»¶
                OrderCancelledEvent cancelEvent = OrderCancelledEvent.builder()
                    .orderId(event.getOrderId())
                    .reason("åº“å­˜ä¸è¶³")
                    .build();
                    
                rabbitTemplate.convertAndSend("order.cancelled.exchange",
                    "order.cancelled", cancelEvent);
            }
            
        } catch (Exception e) {
            log.error("å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶å¤±è´¥: {}", event.getOrderId(), e);
            // å‘é€åˆ°é‡è¯•é˜Ÿåˆ—
            retryService.scheduleRetry(event, "order.created.retry");
        }
    }
    
    // 2. æ”¯ä»˜æˆåŠŸäº‹ä»¶å¤„ç†
    @RabbitListener(queues = "payment.success.queue")
    public void handlePaymentSuccess(PaymentSuccessEvent event) {
        log.info("å¤„ç†æ”¯ä»˜æˆåŠŸäº‹ä»¶: {}", event.getOrderId());
        
        try {
            // ç¡®è®¤åº“å­˜æ‰£å‡
            inventoryService.confirmReservation(event.getOrderId());
            
            // æ›´æ–°è®¢å•çŠ¶æ€
            orderService.updateStatus(event.getOrderId(), OrderStatus.PAID);
            
            // å‘é€åˆ°å±¥çº¦é˜Ÿåˆ—
            FulfillmentRequest fulfillmentRequest = FulfillmentRequest.builder()
                .orderId(event.getOrderId())
                .shippingAddress(event.getShippingAddress())
                .build();
                
            rabbitTemplate.convertAndSend("fulfillment.exchange",
                "fulfillment.process", fulfillmentRequest);
                
            // å‘é€ç”¨æˆ·é€šçŸ¥
            NotificationMessage notification = NotificationMessage.builder()
                .userId(event.getUserId())
                .type(NotificationType.ORDER_PAID)
                .content("æ‚¨çš„è®¢å• " + event.getOrderId() + " æ”¯ä»˜æˆåŠŸ")
                .build();
                
            rabbitTemplate.convertAndSend("notification.fanout",
                "", notification);
                
        } catch (Exception e) {
            log.error("å¤„ç†æ”¯ä»˜æˆåŠŸäº‹ä»¶å¤±è´¥: {}", event.getOrderId(), e);
            // è¿™é‡Œéœ€è¦ç‰¹åˆ«å°å¿ƒï¼Œå¯èƒ½éœ€è¦äººå·¥ä»‹å…¥
            alertService.sendCriticalAlert("æ”¯ä»˜åå¤„ç†å¤±è´¥", event.getOrderId());
        }
    }
    
    // 3. æ”¯ä»˜å¤±è´¥äº‹ä»¶å¤„ç†
    @RabbitListener(queues = "payment.failed.queue")
    public void handlePaymentFailed(PaymentFailedEvent event) {
        log.info("å¤„ç†æ”¯ä»˜å¤±è´¥äº‹ä»¶: {}", event.getOrderId());
        
        try {
            // é‡Šæ”¾åº“å­˜
            inventoryService.releaseReservation(event.getOrderId());
            
            // æ›´æ–°è®¢å•çŠ¶æ€
            orderService.updateStatus(event.getOrderId(), OrderStatus.PAYMENT_FAILED);
            
            // å‘é€ç”¨æˆ·é€šçŸ¥
            NotificationMessage notification = NotificationMessage.builder()
                .userId(event.getUserId())
                .type(NotificationType.PAYMENT_FAILED)
                .content("è®¢å• " + event.getOrderId() + " æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡æ–°æ”¯ä»˜")
                .build();
                
            rabbitTemplate.convertAndSend("notification.fanout",
                "", notification);
                
        } catch (Exception e) {
            log.error("å¤„ç†æ”¯ä»˜å¤±è´¥äº‹ä»¶å¤±è´¥: {}", event.getOrderId(), e);
        }
    }
}
```

**å­¦ä¹ ç›®æ ‡ï¼š**
1. ç†è§£å¤æ‚ä¸šåŠ¡æµç¨‹çš„æ¶ˆæ¯è®¾è®¡
2. æŒæ¡äº‹ä»¶é©±åŠ¨æ¶æ„çš„å®ç°
3. å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡å’Œä¸€è‡´æ€§é—®é¢˜

---

## ğŸ“Š å­¦ä¹ æˆæœéªŒæ”¶

### é˜¶æ®µæ€§æ£€éªŒé¡¹ç›®

#### æ£€éªŒé¡¹ç›®1ï¼šå‹åŠ›æµ‹è¯•ï¼ˆç¬¬8å‘¨æœ«ï¼‰
```bash
# ä½¿ç”¨JMeteræˆ–è‡ªå†™è„šæœ¬è¿›è¡Œå‹åŠ›æµ‹è¯•
# ç›®æ ‡ï¼š1000 msg/sï¼ŒP99å»¶è¿Ÿ < 100ms
# æµ‹è¯•åœºæ™¯ï¼š
# 1. å•ä¸€é˜Ÿåˆ—é«˜å¹¶å‘
# 2. å¤šé˜Ÿåˆ—å¹¶å‘å¤„ç†
# 3. å¼‚å¸¸åœºæ™¯ä¸‹çš„æ¢å¤èƒ½åŠ›
```

#### æ£€éªŒé¡¹ç›®2ï¼šæ•…éšœæ¨¡æ‹Ÿï¼ˆç¬¬10å‘¨æœ«ï¼‰
```bash
# æ•…éšœæ³¨å…¥æµ‹è¯•
# 1. ç½‘ç»œåˆ†åŒº
# 2. æ¶ˆè´¹è€…crash
# 3. RabbitMQæœåŠ¡é‡å¯
# 4. æ•°æ®åº“è¿æ¥è¶…æ—¶
```

#### æ£€éªŒé¡¹ç›®3ï¼šç”Ÿäº§éƒ¨ç½²ï¼ˆç¬¬12å‘¨æœ«ï¼‰
```bash
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²checklist
# 1. ç›‘æ§å‘Šè­¦é…ç½®å®Œæ•´
# 2. å®‰å…¨é…ç½®åˆ°ä½
# 3. å¤‡ä»½æ¢å¤æ–¹æ¡ˆ
# 4. è¿ç»´æ–‡æ¡£å®Œæ•´
```

### æœ€ç»ˆç›®æ ‡

å®Œæˆ12å‘¨å­¦ä¹ åï¼Œä½ å°†å…·å¤‡ï¼š

- âœ… **æ·±åº¦ç†è§£**ï¼šRabbitMQçš„æ ¸å¿ƒåŸç†å’Œæœ€ä½³å®è·µ
- âœ… **å®æˆ˜èƒ½åŠ›**ï¼šç‹¬ç«‹è®¾è®¡å’Œå®ç°ä¼ä¸šçº§æ¶ˆæ¯ç³»ç»Ÿ
- âœ… **é—®é¢˜è§£å†³**ï¼šå¿«é€Ÿè¯Šæ–­å’Œè§£å†³ç”Ÿäº§ç¯å¢ƒé—®é¢˜
- âœ… **æ¶æ„è®¾è®¡**ï¼šåŸºäºæ¶ˆæ¯çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡èƒ½åŠ›
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šç³»ç»Ÿæ€§èƒ½è°ƒä¼˜å’Œå®¹é‡è§„åˆ’èƒ½åŠ›

### è¿›é˜¶æ–¹å‘

å­¦ä¹ å®Œæˆåï¼Œå¯ä»¥è¿›ä¸€æ­¥æ¢ç´¢ï¼š

1. **æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹**ï¼šKafkaã€Pulsarã€NATSå¯¹æ¯”
2. **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šSagaæ¨¡å¼ã€äº‹ä»¶æº¯æº
3. **äº‘åŸç”Ÿ**ï¼šKuberneteséƒ¨ç½²ã€Serverlessæ¶ˆæ¯å¤„ç†
4. **æµå¤„ç†**ï¼šå®æ—¶æ•°æ®æµå¤„ç†å’Œåˆ†æ

è¿™ä¸ªå­¦ä¹ è·¯å¾„å°†å¸®åŠ©ä½ ä»ç°æœ‰çš„åŸºç¡€Demoå‡ºå‘ï¼Œç³»ç»Ÿæ€§åœ°æŒæ¡ä¼ä¸šçº§RabbitMQåº”ç”¨ï¼Œæˆä¸ºæ¶ˆæ¯é˜Ÿåˆ—é¢†åŸŸçš„ä¸“å®¶ï¼