# RabbitMQ 八股

## AMQP协议

AMQP（Advanced Message Queuing Protocol）是一种高级消息队列协议，用于在应用程序之间传递消息。
它定义了消息传递的格式、路由、安全性和可靠性机制。
主要用于组件之间的解耦,消息发送者不需要知道消息的接收者是谁,只需要将消息发送到消息队列中,消息接收者从消息队列中获取消息。

AMQP三层协议

- Module Layer: 协议最高层,定义一些客户端调用的命令,客户端可以用这些命令实现自己的业务逻辑.
- Session Layer: 中间层,负责客户端命令发送到服务器,再将服务器端应答返回给客户端,提供可靠性同步机制和错误处理.
- TransportLayer: 最底层,主要传输二进制数据流,提供帧的处理,信道复用,错误检测和数据表示.

AMQP组件

- 交换器(Exchange): 接收消息,根据路由键将消息路由到对应的队列.
- 队列(Queue): 消息的缓冲区,存储消息,等待消费者消费.
- 绑定(Binding): 将交换器和队列绑定在一起,定义了消息的路由规则.

## RabbitMQ包含哪些要素

- 生产者: 消息队列创建者,发送消息到MQ.
- 消费者: 连接到MQ,订阅到队列上,消费消息,持续订阅和单条订阅.
- 消息: 包含有效载荷和标签. 有效载荷是消息的实际内容,标签是消息的属性,用于路由和过滤消息.

## RabbitMQ各个部分的概念

### 信道

生产者,消费者与RabbitMQ通信的通道,生产者publish或者消费者subscribe 一个队列都是通过信道来通信.
建立在TCP连接上的虚拟连接,一个信道就是一个连接中的虚拟连接,一个连接可以包含多个信道.
一条TCP上建立成百上千个信道达到多线程处理,这个TCP被多个线程共享,每个线程对应一个信道.
信道在RabbitMQ中有唯一的ID,保证了信道的私有性,对应上唯一的线程使用.

### Broker

指一个或多个erlang node 的逻辑分组,且node上运行着RabbitMQ应用服务.

### Cluster

cluster 是在Broker基础上,增加了node之间共享元数据的约束.

### Exchange

生产者发送消息到交换器,交换器根据路由键将消息路由到对应的队列.
路由不到时返回给生产者或者直接丢弃.

### RoutingKey

生产者将消息发送给交换器时,会指定一个RoutingKey,用来指定这个消息的路由规则,这个RoutingKey需要与交换器类型和绑定键(BindingKey)联合使用才能最终生效.

### Binding

通过绑定将交换器和队列关联起来,一般会指定一个BindingKey,这样MQ就知道如何正确路由消息到队列了.

### 死信队列

消息被拒绝,或者TTL过期,或者队列满了,都会进入死信队列.

### vhost

可被理解为虚拟broker,一个broker里可以有多个vhost,每个vhost本质上是一个mini-rabbitmq server,拥有自己的队列,交换器,绑定和权限机制.
拥有独立的权限系统,可以做到不同用户使用不同的vhost,互不干扰.

## MQ的RoutingKey和BindingKey 的最大长度是多少?

255字节.

## MQ消息可能有几种状态?

- alpha: 消息内容和消息索引都存储到内存,消息不落盘,重启后消息丢失.
- beta: 消息内容存储磁盘,消息索引存储到内存,消息落盘,重启后消息不丢失.
- gamma: 消息内容保存在磁盘,消息索引存储磁盘和内存都有.
- delta: 消息内容和消息索引都存储到磁盘,消息落盘,重启后消息不丢失.

## MQ的消息传输保证层级?

- At most once: 最多一次. 消息可能会丢失,但不会重复传递.
- At least once: 最少一次. 消息绝不会丢失,但可能会重复传递.
- Exactly once: 精确一次. 每条消息肯定只传递一次.

## MQ的工作模式

### simple模式(简单收发模式)

消息生产者发送消息到队列,消息消费者从队列中获取消息,消费被拿走后,自动从队列中删除.

### work模式(工作队列模式)

消息产生者将消息发送到队列,多个消费者从队列中获取消息,可以有多个消费者,消费者处理消息的能力不同,
可能某个消息被多个消费者共同使用,可以设置syncronize包装一个消息只被一个消费者使用.

### publish/subscribe模式(发布/订阅模式)

每个消费者监听自己的队列.
生产者将消息发给broker,由交换器将消息转发到绑定到交换器的所有队列.每个绑定交换机的队列都能收到消息.

### routing模式(路由模式)

生产者将消息发给交换机按照路由判断,匹配到队列,将消息发给队列.

### topic主题模式(路由模式的一种)

为路由功能添加的模糊匹配,产生消息交给交换机,交换机根据key的规则模糊匹配到对应的队列,由队列的监听消费者接收消费.

## 发送消息的过程?

- 生产者将消息发布到n(1-n)个交换器(Exchange)中.交换器的作用是根据路由键(RoutingKey)将消息路由到对应的队列(Queue)中.
- 交换器根据路由键将消息路由到对应的队列中.如果路由键为空, 消息会被分配给所有绑定到该交换器的队列.
- 消息进入队列,等待被消费者接收.
- 在队列中消息被存储在持久化存储中,防止服务器崩溃或重启时数据丢失.
- 消费者从队列中获取消息并进行处理,消费者可以通过订阅一个或多个队列来接收信息.一旦消息被消费者接收,它将从队列中移除.

## 为什么要使用RabbitMQ?

- 实现消费者和生产者之间的解耦.
- 可以使用消息队列达到异步的效果.
- 对于高并发场景,可以将同步访问变为串行访问达到一定量的限流,有利于数据库的操作.
- 拥有持久化的机制,进程消息,队列中的消息也可以保存下来.

## RabbitMQ缺点?

- 复杂性: 一定的学习和理解成本,配置,管理和监控方面.
- 存储要求: 依赖于磁盘进行消息存储,需要一定的存储空间,并需要定期清理过期消息.
- 配置要求: RabbitMQ可靠性,性能等都和配置有关系,如果配置不当可能有性能问题或者消息丢失等问题.
